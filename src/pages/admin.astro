---
import Layout from '../layouts/Layout.astro'
---

<Layout title="Panel Admin" description="Administración de productos">
  <section id="adminPanel">
    <p>Cargando...</p>
  </section>

  <script type="module">
    async function checkAuth() {
      const panel = document.getElementById('adminPanel')

      try {
        const res = await fetch('http://localhost:4000/auth/validate', {
          credentials: 'include',
        })
        const data = await res.json()

        if (data.loggedIn) {
          panel.innerHTML = `
            <h2>Bienvenido, ${data.username}</h2>
            <ul>
              <li><button onclick="crearProducto()">Agregar producto</button></li>
              <li><button onclick="eliminarProducto()">Eliminar producto</button></li>
              <li><button onclick="cambiarCredenciales()">Cambiar usuario/clave</button></li>
            </ul>
          `
        } else {
          showLoginForm(panel)
        }
      } catch {
        showLoginForm(panel)
      }
    }

    function showLoginForm(container) {
      container.innerHTML = `
        <h2>Iniciar sesión</h2>
        <form id="loginForm">
        <div class="usernameContainer">
          <label for="username">Usuario:</label>
          <input type="text" name="username" placeholder="Usuario" required />
        </div>
        <div class="passwordContainer">
          <label for="password">Contraseña:</label>
          <input type="password" name="password" placeholder="Contraseña" required />
        </div>
        <div class="buttonContainer">
          <button type="submit">Entrar</button>
        </div>
        </form>
      `
      document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault()
        const formData = new FormData(e.target)
        const data = Object.fromEntries(formData.entries())

        const res = await fetch('http://localhost:4000/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data),
        })
        console.log(res)

        const result = await res.json()
        if (result.success) {
          location.reload()
        } else {
          alert('Usuario o contraseña incorrectos')
        }
      })
    }

    checkAuth()
  </script>
</Layout>

<style global>
  .loginForm {
    display: flex;
    flex-direction: column;
    width: 300px;
    margin: auto;
  }

  .usernameContainer,
  .passwordContainer,
  .buttonContainer {
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 5px;
  }

  input {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
  }

  button {
    padding: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  button:hover {
    background-color: #0056b3;
  }
</style>
